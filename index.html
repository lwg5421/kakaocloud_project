<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì „ë¶ ë©”ë‹¬ ë§ˆìŠ¤í„° 14</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #667eea; --secondary: #764ba2; 
            --gold: #FFD700; --gold-dark: #b8860b; --gold-border: #D4AF37;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background: #f0f2f5; min-height: 100vh; color: #333; }
        .app-container { max-width: 430px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        
        /* Header & Nav */
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 25px 25px; }
        .nav { display: flex; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 16px; border: none; background: none; color: #aaa; font-weight: 700; cursor: pointer; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .content { padding: 20px; padding-bottom: 40px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

        /* Scanner */
        .camera-box { width: 100%; aspect-ratio: 1; background: #1a1a1a; border-radius: 24px; overflow: hidden; border: 6px solid #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        #reader { width: 100%; height: 100%; }

        /* Stamps Grid */
        .stamps-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stamp { background: white; border-radius: 20px; padding: 20px 15px; text-align: center; border: 1px solid #edf2f7; transition: 0.3s; cursor: pointer; }
        
        /* í™©ê¸ˆ ë©”ë‹¬ ë””ìì¸ (ë‚´ë¶€ í°ìƒ‰ ê¸€ì”¨ ê°ì¸) */
        .medal-coin {
            width: 100px; height: 100px; margin: 0 auto 12px; border-radius: 50%;
            background: linear-gradient(145deg, #FFD700 0%, #FDB931 50%, #D4AF37 100%);
            border: 4px solid var(--gold-border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15), inset 0 0 12px rgba(255,255,255,0.6);
            position: relative; color: white;
        }
        .medal-coin i { font-size: 32px; margin-bottom: 4px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .medal-text { font-size: 0.65rem; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        .stamp.locked .medal-coin { background: #e2e8f0; border-color: #cbd5e1; box-shadow: none; filter: grayscale(1); opacity: 0.3; }
        .stamp-name { font-weight: 800; font-size: 0.95rem; color: #2d3748; margin-top: 5px; }
        .stamp-date { font-size: 0.6rem; color: var(--primary); margin-top: 8px; font-weight: 600; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; padding: 25px; backdrop-filter: blur(5px); }
        .modal-body { background: white; border-radius: 35px; padding: 35px; width: 100%; max-width: 360px; text-align: center; }
        .big-medal-box { transform: scale(1.7); margin: 40px auto; animation: medalRotate 5s linear infinite; }

        @keyframes medalRotate { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>ì „ë¶ ë©”ë‹¬ ë§ˆìŠ¤í„° 14</h1>
            <p>í™©ê¸ˆë¹› ë©”ë‹¬ ì†ì— ë‹´ê¸´ ë‚˜ì˜ ê¸°ë¡</p>
        </header>

        <nav class="nav">
            <button class="tab active" onclick="switchTab('scanner', event)">ì¸ì¦í•˜ê¸°</button>
            <button class="tab" onclick="switchTab('stamps', event)">ë³´ê´€í•¨</button>
            <button class="tab" onclick="switchTab('rewards', event)">ë³´ìƒ</button>
        </nav>

        <main class="content">
            <div id="scanner" class="tab-content active">
                <div class="camera-box"><div id="reader"></div></div>
                <div style="margin-top:25px; text-align:center;">
                    <p style="color:#4a5568; font-weight:700;">QR ìŠ¤ìº”ìœ¼ë¡œ ë©”ë‹¬ íšë“</p>
                    <p style="color:#a0aec0; font-size:0.8rem; margin-top:5px;">ì¥ì†Œì˜ í˜•ìƒê³¼ ì´ë¦„ì´ ìƒˆê²¨ì§„ ë©”ë‹¬ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div id="stamps" class="tab-content">
                <div style="background:#fff; padding:15px; border-radius:15px; margin-bottom:20px; text-align:center; border:1px solid #eee;">
                    <span id="count-txt" style="font-weight:800; color:var(--primary);">0</span> / 14 ìˆ˜ì§‘ë¨
                </div>
                <div class="stamps-grid" id="stamps-grid"></div>
            </div>

            <div id="rewards" class="tab-content">
                <h3 style="margin-bottom:20px;">ğŸ… ë‹¬ì„± ë³´ìƒ</h3>
                <div id="reward-list"></div>
                <button onclick="resetAllData()" style="width:100%; margin-top:30px; padding:12px; background:#fee2e2; color:#ef4444; border:none; border-radius:12px; font-size:0.8rem; font-weight:bold;">ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
        </main>
    </div>

    <div id="medal-modal" class="modal">
        <div class="modal-body">
            <h2 id="modal-title" style="color:var(--gold-dark);">ìˆ˜ì§‘ ì„±ê³µ!</h2>
            <div id="modal-medal-box" class="big-medal-box"></div>
            <p id="modal-time" style="font-size:0.75rem; color:#a0aec0; margin-bottom:15px;"></p>
            <div id="ai-message" style="background:#f8f9fa; padding:15px; border-radius:15px; font-size:0.85rem; text-align:left; margin-bottom:20px;"></div>
            <button onclick="closeModal()" style="width:100%; padding:16px; background:linear-gradient(to right, var(--primary), var(--secondary)); color:white; border:none; border-radius:18px; font-weight:bold;">ë³´ê´€í•¨ ì €ì¥</button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const GEMINI_API_KEY = "AIzaSyCVHba-NStXNvtUE7g25iir4zyRHWkqXH8"; 
        
        let landmarks = [
            { id: 1, region: 'ì „ì£¼', name: 'ê²½ê¸°ì „', icon: 'fa-solid fa-archway' },
            { id: 2, region: 'êµ°ì‚°', name: 'ì² ê¸¸ë§ˆì„', icon: 'fa-solid fa-train-subway' },
            { id: 3, region: 'ìµì‚°', name: 'ë¯¸ë¥µì‚¬ì§€', icon: 'fa-solid fa-monument' },
            { id: 4, region: 'ì •ì', name: 'ë‹¨í’í„°ë„', icon: 'fa-solid fa-leaf' },
            { id: 5, region: 'ë‚¨ì›', name: 'ê´‘í•œë£¨ì›', icon: 'fa-solid fa-moon' },
            { id: 6, region: 'ê¹€ì œ', name: 'ë²½ê³¨ì œ', icon: 'fa-solid fa-wheat-awn' },
            { id: 7, region: 'ì™„ì£¼', name: 'ì˜ˆìˆ ì´Œ', icon: 'fa-solid fa-palette' },
            { id: 8, region: 'ì§„ì•ˆ', name: 'ë§ˆì´ì‚°', icon: 'fa-solid fa-mountain-sun' },
            { id: 9, region: 'ë¬´ì£¼', name: 'ë•ìœ ì‚°', icon: 'fa-solid fa-snowflake' },
            { id: 10, region: 'ì¥ìˆ˜', name: 'ë…¼ê°œì‚¬ë‹¹', icon: 'fa-solid fa-torii-gate' },
            { id: 11, region: 'ì„ì‹¤', name: 'ì¹˜ì¦ˆíŒŒí¬', icon: 'fa-solid fa-cheese' },
            { id: 12, region: 'ìˆœì°½', name: 'êµ¬ë¦„ë‹¤ë¦¬', icon: 'fa-solid fa-bridge' },
            { id: 13, region: 'ê³ ì°½', name: 'ê³ ì°½ìì„±', icon: 'fa-solid fa-fort-awesome' },
            { id: 14, region: 'ë¶€ì•ˆ', name: 'ì±„ì„ê°•', icon: 'fa-solid fa-water' }
        ];

        // 1. ë©”ë‹¬ ì½”ì¸ ìƒì„± (ê·¸ë¦¼ + í°ìƒ‰ í…ìŠ¤íŠ¸)
        function generateMedalCoin(spot) {
            return `
                <div class="medal-coin">
                    <i class="${spot.icon}"></i>
                    <div class="medal-text">${spot.name}</div>
                </div>
            `;
        }

        window.onload = () => { loadProgress(); startScanner(); };

        function loadProgress() {
            const saved = localStorage.getItem('jb_medal_v_final');
            if (saved) {
                const parsed = JSON.parse(saved);
                parsed.forEach((p, i) => { if(landmarks[i]) landmarks[i] = {...landmarks[i], ...p}; });
            }
        }

        function saveProgress() { localStorage.setItem('jb_medal_v_final', JSON.stringify(landmarks)); }

        async function startScanner() {
            if (html5QrCode) await html5QrCode.stop().catch(()=>{});
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                if(txt === "MASTER_ALL") {
                    landmarks.forEach(l => { l.collected = true; l.date = new Date().toLocaleString(); });
                    saveProgress(); location.reload(); return;
                }
                const spot = landmarks.find(l => l.id === parseInt(txt));
                if(spot && !spot.collected) processMedal(spot);
            }).catch(()=>{});
        }

        async function processMedal(spot) {
            if (html5QrCode) await html5QrCode.stop().catch(()=>{});
            const now = new Date();
            const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            spot.collected = true;
            spot.date = timeStr;
            saveProgress();

            document.getElementById('modal-title').innerText = `${spot.region} ë©”ë‹¬`;
            document.getElementById('modal-time').innerText = `íšë“: ${timeStr}`;
            document.getElementById('modal-medal-box').innerHTML = generateMedalCoin(spot);
            
            const msg = await fetchGemini(spot);
            document.getElementById('ai-message').innerText = msg;
            document.getElementById('medal-modal').style.display = 'flex';
        }

        async function fetchGemini(spot) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `${spot.name} ë°©ë¬¸ ì¶•í•˜ ë©˜íŠ¸ í•œì¤„ ì¨ì¤˜.` }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch { return "ë©‹ì§„ ì—¬ì •ì„ ì‘ì›í•©ë‹ˆë‹¤!"; }
        }

        function renderStamps() {
            const g = document.getElementById('stamps-grid');
            g.innerHTML = '';
            landmarks.forEach((l) => {
                const d = document.createElement('div');
                d.className = `stamp ${l.collected ? 'collected' : 'locked'}`;
                d.onclick = () => {
                    if(l.collected && confirm(`'${l.name}' ë©”ë‹¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        l.collected = false; delete l.date; saveProgress(); renderStamps();
                    }
                };
                d.innerHTML = `
                    ${generateMedalCoin(l)}
                    <div class="stamp-name">${l.region}</div>
                    ${l.collected ? `<div class="stamp-date">${l.date}</div>` : ''}
                `;
                g.appendChild(d);
            });
            document.getElementById('count-txt').innerText = landmarks.filter(l => l.collected).length;
        }

        function switchTab(t, e) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            if(e) e.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            if (t === 'stamps') renderStamps();
            if (t === 'rewards') renderRewards();
        }

        function renderRewards() {
            const r = document.getElementById('reward-list');
            r.innerHTML = '';
            const count = landmarks.filter(l => l.collected).length;
            [{n:3, g:'ì»¤í”¼'}, {n:7, g:'ìƒí’ˆê¶Œ'}, {n:14, g:'í•œì • êµ¿ì¦ˆ'}].forEach(m => {
                const active = count >= m.n;
                r.innerHTML += `
                    <div style="background:#fff; border:1px solid #eee; border-radius:15px; padding:15px; margin-bottom:12px; display:flex; align-items:center; gap:12px; ${active ? 'border-color:var(--gold); background:#fffdf0;' : ''}">
                        <div style="font-size:1.4rem">${active ? 'ğŸ' : 'ğŸ”’'}</div>
                        <div>
                            <h4 style="font-size:0.9rem;">${m.n}ê°œ ë‹¬ì„± ë³´ìƒ</h4>
                            <p style="font-size:0.75rem; color:#718096;">${active ? `íšë“ ì™„ë£Œ: ${m.g}` : `${m.n-count}ê°œ ë” í•„ìš”`}</p>
                        </div>
                    </div>`;
            });
        }

        function resetAllData() { if(confirm("ì •ë§ë¡œ ëª¨ë“  ìˆ˜ì§‘ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); location.reload(); } }
        function closeModal() { document.getElementById('medal-modal').style.display = 'none'; switchTab('stamps'); }
        let html5QrCode;
    </script>
</body>
</html>