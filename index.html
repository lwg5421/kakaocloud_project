<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì „ë¶ ë©”ë‹¬ ë§ˆìŠ¤í„° 14</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --primary: #667eea; --secondary: #764ba2; 
            --gold: #FFD700; --gold-dark: #b8860b; --gold-border: #D4AF37;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background: #f0f2f5; min-height: 100vh; color: #333; }
        .app-container { max-width: 430px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        
        /* Header & Nav */
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 25px 25px; }
        .nav { display: flex; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 16px; border: none; background: none; color: #aaa; font-weight: 700; cursor: pointer; font-size: 0.85rem; transition: 0.3s; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .content { padding: 20px; padding-bottom: 40px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

        /* Scanner */
        .camera-box { width: 100%; aspect-ratio: 1; background: #1a1a1a; border-radius: 24px; overflow: hidden; border: 6px solid #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        #reader { width: 100%; height: 100%; }

        /* Stamps Grid */
        .stamps-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stamp { background: white; border-radius: 20px; padding: 20px 15px; text-align: center; border: 1px solid #edf2f7; transition: 0.2s; cursor: pointer; }
        .stamp:active { transform: scale(0.95); }
        .medal-coin {
            width: 95px; height: 95px; margin: 0 auto 12px; border-radius: 50%;
            background: linear-gradient(145deg, #FFD700 0%, #FDB931 50%, #D4AF37 100%);
            border: 4px solid var(--gold-border); display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15), inset 0 0 12px rgba(255,255,255,0.6);
            position: relative; color: white !important;
        }
        .medal-coin i { font-size: 32px !important; margin-bottom: 4px !important; color: #ffffff !important; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.25)); }
        .medal-text { font-size: 0.6rem; font-weight: 900; color: #ffffff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .stamp.locked .medal-coin { background: #e2e8f0; border-color: #cbd5e1; filter: grayscale(1); opacity: 0.3; }

        /* AI Route Map UI ë³´ê°• */
        #route-map-container {
            background: #eef2ff; border-radius: 20px; padding: 15px; margin-bottom: 20px; border: 1px solid #dee2e6;
        }
        #route-map { 
            position: relative; height: 220px; background: #fff; border-radius: 15px; overflow: hidden;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; /* ê²©ì ë¬´ëŠ¬ */
        }
        .map-dot { 
            position: absolute; width: 14px; height: 14px; background: #ff4757; border-radius: 50%; 
            border: 2px solid white; box-shadow: 0 0 10px rgba(255, 71, 87, 0.5); transform: translate(-50%, -50%); z-index: 5; 
        }
        .map-line {
            position: absolute; background: var(--primary); height: 2px; transform-origin: top left; opacity: 0.4; z-index: 1;
        }
        .route-step {
            background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee;
            display: flex; align-items: center; gap: 12px; font-size: 0.85rem;
        }
        .step-num {
            width: 24px; height: 24px; background: var(--primary); color: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7rem;
        }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; padding: 25px; backdrop-filter: blur(5px); }
        .modal-body { background: white; border-radius: 35px; padding: 35px; width: 100%; max-width: 360px; text-align: center; }
        .big-medal-box { transform: scale(1.6); margin: 45px auto; animation: medalRotate 5s linear infinite; display: flex; justify-content: center; }

        @keyframes medalRotate { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>ì „ë¶ ë©”ë‹¬ ë§ˆìŠ¤í„° 14</h1>
            <p>AIê°€ ì¶”ì²œí•˜ëŠ” ë‚˜ë§Œì˜ ì—¬ì •</p>
        </header>

        <nav class="nav">
            <button class="tab active" onclick="switchTab('scanner', event)">ì¸ì¦í•˜ê¸°</button>
            <button class="tab" onclick="switchTab('stamps', event)">ë³´ê´€í•¨</button>
            <button class="tab" onclick="switchTab('ai-route', event)">AI ê²½ë¡œ</button>
            <button class="tab" onclick="switchTab('rewards', event)">ë³´ìƒ</button>
        </nav>

        <main class="content">
            <div id="scanner" class="tab-content active">
                <div class="camera-box"><div id="reader"></div></div>
                <div style="margin-top:25px; text-align:center;">
                    <p style="color:#4a5568; font-weight:700;">ëœë“œë§ˆí¬ QR ìŠ¤ìº”</p>
                    <p style="color:#a0aec0; font-size:0.8rem; margin-top:5px;">ì¥ì†Œì˜ ê·¸ë¦¼ê³¼ ì´ë¦„ì´ ê°ì¸ëœ ë©”ë‹¬ì„ ëª¨ìœ¼ì„¸ìš”.</p>
                </div>
            </div>

            <div id="stamps" class="tab-content">
                <div style="margin-bottom:15px; text-align:right; font-size:0.85rem; font-weight:bold; color:var(--primary);">
                    ìˆ˜ì§‘ í˜„í™©: <span id="count-txt">0</span>/14
                </div>
                <div class="stamps-grid" id="stamps-grid"></div>
            </div>

            <div id="ai-route" class="tab-content">
                <div style="margin-bottom:20px;">
                    <h3 style="color:var(--secondary); font-size:1.1rem; margin-bottom:5px;">âœ¨ AI ì¶”ì²œ ì½”ìŠ¤</h3>
                    <p style="font-size:0.75rem; color:#718096;">ì•„ì§ ë°©ë¬¸í•˜ì§€ ì•Šì€ ì¥ì†Œ ì¤‘ ìµœì ì˜ ê²½ë¡œë¥¼ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.</p>
                </div>
                
                <div id="route-map-container">
                    <div id="route-map"><div id="map-inner"></div></div>
                </div>

                <div id="route-list"></div>
                
                <button onclick="generateAIRoute()" style="width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:bold; cursor:pointer; margin-top:10px; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);">
                    ì½”ìŠ¤ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>

            <div id="rewards" class="tab-content">
                <h3 style="margin-bottom:20px;">ğŸ íŠ¹ë³„ ë³´ìƒ</h3>
                <div id="reward-list"></div>
                <button onclick="resetData()" style="width:100%; margin-top:40px; padding:12px; background:#fff1f1; color:#ef4444; border:1px solid #fee2e2; border-radius:12px; font-size:0.75rem; font-weight:bold;">ë°ì´í„° ì´ˆê¸°í™”</button>
            </div>
        </main>
    </div>

    <div id="medal-modal" class="modal">
        <div class="modal-body">
            <h2 id="modal-title" style="color:var(--gold-dark);">ë©”ë‹¬ ìˆ˜ì§‘!</h2>
            <div id="modal-medal-box" class="big-medal-box"></div>
            <p id="modal-time" style="font-size:0.75rem; color:#a0aec0; margin-bottom:15px;"></p>
            <div id="ai-message" style="background:#f0f4ff; padding:15px; border-radius:15px; font-size:0.85rem; text-align:left; margin-bottom:20px; line-height:1.5; color:#4a5568;"></div>
            <button onclick="closeModal()" style="width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:bold;">ë³´ê´€í•¨ì— ì €ì¥</button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const GEMINI_API_KEY = "AIzaSyCVHba-NStXNvtUE7g25iir4zyRHWkqXH8"; 
        
        let landmarks = [
            { id: 1, region: 'ì „ì£¼', name: 'ê²½ê¸°ì „', icon: 'fa-solid fa-archway', x: 50, y: 30 },
            { id: 2, region: 'êµ°ì‚°', name: 'ì² ê¸¸ë§ˆì„', icon: 'fa-solid fa-train-subway', x: 20, y: 20 },
            { id: 3, region: 'ìµì‚°', name: 'ë¯¸ë¥µì‚¬ì§€', icon: 'fa-solid fa-monument', x: 35, y: 15 },
            { id: 4, region: 'ì •ì', name: 'ë‚´ì¥ì‚°', icon: 'fa-solid fa-leaf', x: 30, y: 70 },
            { id: 5, region: 'ë‚¨ì›', name: 'ê´‘í•œë£¨ì›', icon: 'fa-solid fa-moon', x: 70, y: 80 },
            { id: 6, region: 'ê¹€ì œ', name: 'ë²½ê³¨ì œ', icon: 'fa-solid fa-wheat-awn', x: 25, y: 45 },
            { id: 7, region: 'ì™„ì£¼', name: 'ì˜ˆìˆ ì´Œ', icon: 'fa-solid fa-palette', x: 55, y: 20 },
            { id: 8, region: 'ì§„ì•ˆ', name: 'ë§ˆì´ì‚°', icon: 'fa-solid fa-mountain-sun', x: 75, y: 35 },
            { id: 9, region: 'ë¬´ì£¼', name: 'ë•ìœ ì‚°', icon: 'fa-solid fa-snowflake', x: 85, y: 25 },
            { id: 10, region: 'ì¥ìˆ˜', name: 'ë…¼ê°œì‚¬ë‹¹', icon: 'fa-solid fa-torii-gate', x: 80, y: 55 },
            { id: 11, region: 'ì„ì‹¤', name: 'ì¹˜ì¦ˆíŒŒí¬', icon: 'fa-solid fa-cheese', x: 60, y: 60 },
            { id: 12, region: 'ìˆœì°½', name: 'ê°•ì²œì‚°', icon: 'fa-solid fa-bridge', x: 50, y: 85 },
            { id: 13, region: 'ê³ ì°½', name: 'ê³ ì°½ìì„±', icon: 'fa-solid fa-fort-awesome', x: 15, y: 80 },
            { id: 14, region: 'ë¶€ì•ˆ', name: 'ì±„ì„ê°•', icon: 'fa-solid fa-water', x: 10, y: 55 }
        ];

        function generateMedalCoin(spot) {
            return `<div class="medal-coin"><i class="${spot.icon}"></i><div class="medal-text">${spot.name}</div></div>`;
        }

        window.onload = () => { loadProgress(); startScanner(); };

        function loadProgress() {
            const saved = localStorage.getItem('jb_medal_v_final');
            if (saved) {
                const parsed = JSON.parse(saved);
                parsed.forEach((p, i) => { if(landmarks[i]) landmarks[i] = {...landmarks[i], ...p}; });
            }
        }
        function saveProgress() { localStorage.setItem('jb_medal_v_final', JSON.stringify(landmarks)); }

        async function startScanner() {
            if (html5QrCode) await html5QrCode.stop().catch(()=>{});
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                if(txt === "MASTER_ALL") {
                    landmarks.forEach(l => { l.collected = true; l.date = new Date().toLocaleString(); });
                    saveProgress(); renderStamps(); switchTab('stamps'); return;
                }
                const spot = landmarks.find(l => l.id === parseInt(txt));
                if (spot) {
                    if (spot.collected) alert("ì´ë¯¸ ìˆ˜ì§‘í•œ ë©”ë‹¬ì…ë‹ˆë‹¤! ğŸ…");
                    else processMedal(spot);
                }
            }).catch(()=>{});
        }

        async function processMedal(spot) {
            if (html5QrCode) await html5QrCode.stop().catch(()=>{});
            const now = new Date();
            const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            spot.collected = true; spot.date = timeStr; saveProgress();

            document.getElementById('modal-title').innerText = `${spot.region} ë©”ë‹¬`;
            document.getElementById('modal-time').innerText = `ìˆ˜ì§‘ì¼ì‹œ: ${timeStr}`;
            document.getElementById('modal-medal-box').innerHTML = generateMedalCoin(spot);
            
            document.getElementById('ai-message').innerText = "AIê°€ ë°©ë¬¸ ê¸°ë¡ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";
            document.getElementById('medal-modal').style.display = 'flex';
            
            const msg = await fetchGemini(spot);
            document.getElementById('ai-message').innerText = msg;
        }

        async function fetchGemini(spot) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `${spot.name} ë°©ë¬¸ ê¸°ë… ì¶•í•˜ ë©”ì‹œì§€ í•œì¤„ ì¨ì¤˜.` }] }] })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "ì „ë¶ì˜ ì•„ë¦„ë‹¤ì›€ì„ ìˆ˜ì§‘í•˜ì…¨êµ°ìš”!"; }
        }

        function renderStamps() {
            const g = document.getElementById('stamps-grid'); g.innerHTML = '';
            landmarks.forEach((l) => {
                const d = document.createElement('div');
                d.className = `stamp ${l.collected ? 'collected' : 'locked'}`;
                d.onclick = () => {
                    if(l.collected && confirm(`'${l.name}' ë©”ë‹¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        l.collected = false; delete l.date; saveProgress(); renderStamps();
                    }
                };
                d.innerHTML = `${generateMedalCoin(l)}<div class="stamp-name">${l.region}</div>${l.collected ? `<div class="stamp-date">${l.date} ìˆ˜ì§‘</div>` : ''}`;
                g.appendChild(d);
            });
            document.getElementById('count-txt').innerText = landmarks.filter(l => l.collected).length;
        }

        // AI ê²½ë¡œ ìƒì„± ë¡œì§ ë³´ê°•
        function generateAIRoute() {
            const uncollected = landmarks.filter(l => !l.collected).sort(() => 0.5 - Math.random()).slice(0, 3);
            const routeList = document.getElementById('route-list');
            const mapInner = document.getElementById('map-inner');
            routeList.innerHTML = ''; mapInner.innerHTML = '';
            
            if(uncollected.length === 0) {
                routeList.innerHTML = "<div class='route-step'>ğŸ‰ ëª¨ë“  ë©”ë‹¬ì„ ì •ë³µí•˜ì…¨ìŠµë‹ˆë‹¤!</div>";
                return;
            }

            uncollected.forEach((spot, i) => {
                // ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                routeList.innerHTML += `
                    <div class="route-step">
                        <div class="step-num">${i+1}</div>
                        <div>
                            <div style="font-weight:bold;">${spot.name}</div>
                            <div style="font-size:0.7rem; color:#999;">${spot.region} ì§€ì—­ ëª…ì†Œ</div>
                        </div>
                    </div>`;
                
                // ì§€ë„ ë„íŠ¸ ì°ê¸°
                const dot = document.createElement('div');
                dot.className = 'map-dot';
                dot.style.left = `${spot.x}%`;
                dot.style.top = `${spot.y}%`;
                mapInner.appendChild(dot);

                // ë„íŠ¸ ì‚¬ì´ ì„  ì—°ê²° (ì‹œê°í™”)
                if (i > 0) {
                    const prev = uncollected[i-1];
                    const line = document.createElement('div');
                    line.className = 'map-line';
                    const dist = Math.sqrt(Math.pow(spot.x - prev.x, 2) + Math.pow(spot.y - prev.y, 2));
                    const angle = Math.atan2(spot.y - prev.y, spot.x - prev.x) * 180 / Math.PI;
                    line.style.width = `${dist * 4.3}px`; // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ë¹„ë¡€ ì¡°ì •
                    line.style.left = `${prev.x}%`;
                    line.style.top = `${prev.y}%`;
                    line.style.transform = `rotate(${angle}deg)`;
                    mapInner.appendChild(line);
                }
            });
        }

        function renderRewards() {
            const r = document.getElementById('reward-list'); r.innerHTML = '';
            const count = landmarks.filter(l => l.collected).length;
            [{n:3, g:'ì»¤í”¼ ì¿ í°'}, {n:7, g:'ìƒí’ˆê¶Œ 1ë§Œì›'}, {n:14, g:'í•œì •íŒ ì‹¤ë¬¼ ë©”ë‹¬'}].forEach(m => {
                const active = count >= m.n;
                r.innerHTML += `<div style="background:#fff; border:1px solid #eee; border-radius:15px; padding:18px; margin-bottom:12px; display:flex; align-items:center; gap:15px; ${active ? 'border-color:var(--gold); background:#fffdf0; box-shadow:0 4px 10px rgba(212,175,55,0.1);' : ''}">
                    <div style="font-size:1.6rem">${active ? 'ğŸ' : 'ğŸ”’'}</div>
                    <div><h4 style="font-size:0.9rem;">${m.n}ê°œ ìˆ˜ì§‘ ë³´ìƒ</h4><p style="font-size:0.75rem; color:#718096;">${active ? `íšë“ ì™„ë£Œ: ${m.g}` : `${m.n-count}ê°œ ë” ëª¨ìœ¼ë©´ í•´ì œ`}</p></div>
                </div>`;
            });
        }

        function switchTab(t, e) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            if(e) e.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            
            if (t === 'stamps') renderStamps();
            if (t === 'ai-route') generateAIRoute();
            if (t === 'rewards') renderRewards();
            if (t === 'scanner') startScanner();
        }

        function resetData() { if(confirm("ëª¨ë“  ìˆ˜ì§‘ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); location.reload(); } }
        function closeModal() { document.getElementById('medal-modal').style.display = 'none'; switchTab('stamps'); }
        let html5QrCode;
    </script>
</body>
</html>
